<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2 File Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js for reactive components -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
    <style>
        .file-item:hover,
        .folder-item:hover {
            background-color: #ececec;
        }

        .file-item.selected {
            background-color: #e5e7eb;
            border-left: 3px solid #374151;
        }

        .file-item.range-hover {
            background-color: #c4d7ff;
        }

        .file-item {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .modal {
            display: none;
        }

        .modal.active {
            display: flex;
        }

        .toast {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        /* Better focus states */
        button:focus-visible,
        input:focus-visible {
            outline: 2px solid #374151;
            outline-offset: 2px;
        }

        /* Smooth transitions */
        .file-item,
        .folder-item,
        button {
            transition: all 0.15s ease;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <h1 class="text-xl font-bold text-gray-900">R2 Manager V2</h1>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="selectAllFiles()" id="select-all-btn"
                        class="bg-gray-600 hover:bg-gray-700 text-center flex justify-center items-center text-white px-3 py-1.5 rounded text-sm transition">
                        <i data-feather="check-square" class="w-4 h-4 inline mr-1"></i>Select All
                    </button>
                    <button onclick="openUploadModal()"
                        class="bg-gray-600 hover:bg-gray-700 text-center flex justify-center items-center text-white px-3 py-1.5 rounded text-sm transition">
                        <i data-feather="upload" class="w-4 h-4 inline mr-1"></i>Upload
                    </button>
                    <button id="delete-selected-btn" onclick="deleteSelectedFiles()"
                        class="bg-gray-800 hover:bg-gray-900 text-center flex justify-center items-center text-white px-3 py-1.5 rounded text-sm transition hidden">
                        <i data-feather="trash-2" class="w-4 h-4 inline mr-1"></i>Delete (<span
                            id="selected-count">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-4">
        <!-- Compact Header Section -->
        <div class="bg-white rounded shadow-sm p-3 mb-3">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <!-- Breadcrumb Navigation -->
                <div class="flex items-center gap-2 text-sm flex-1 min-w-0">
                    <button onclick="navigateToRoot()"
                        class="text-gray-600 hover:text-gray-800 font-medium flex items-center gap-1 flex-shrink-0">
                        <i data-feather="database" class="text-blue-500 w-4 h-4"></i>
                        <span class="hidden sm:inline text-blue-500">Bucket</span>
                    </button>
                    <span id="breadcrumb" class="text-gray-600 truncate"></span>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center gap-1 flex-wrap">
                    <button onclick="openCreateFolderModal()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-1.5 rounded text-xs transition flex items-center gap-1">
                        <i data-feather="folder-plus" class="w-3.5 h-3.5"></i>
                        <span class="hidden sm:inline">New Folder</span>
                    </button>
                    <button onclick="openCreateFileModal()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-1.5 rounded text-xs transition flex items-center gap-1">
                        <i data-feather="file-plus" class="w-3.5 h-3.5"></i>
                        <span class="hidden sm:inline">New File</span>
                    </button>
                    <button onclick="loadCurrentFolder()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-1.5 rounded text-xs transition flex items-center gap-1">
                        <i data-feather="refresh-ccw" class="w-3.5 h-3.5"></i>
                        <span class="hidden sm:inline">Refresh</span>
                    </button>
                    <button onclick="clearSelection()" id="clear-selection-btn"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs transition hidden flex items-center gap-1">
                        <i data-feather="x" class="w-3.5 h-3.5"></i>
                        <span class="hidden sm:inline">Clear</span>
                    </button>
                </div>
            </div>

            <!-- Compact Keyboard Shortcuts -->
            <div class="mt-2 pt-2 border-t border-gray-100">
                <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-600">
                    <span class="font-medium">Select:</span>
                    <span><kbd class="bg-gray-200 px-1 py-0.5 rounded text-xs">Click</kbd></span>
                    <span><kbd class="bg-gray-200 px-1 py-0.5 rounded text-xs">Shift+Click</kbd></span>
                    <span><kbd class="bg-gray-200 px-1 py-0.5 rounded text-xs">Ctrl+A</kbd></span>
                    <span><kbd class="bg-gray-200 px-1 py-0.5 rounded text-xs">Esc</kbd></span>
                </div>
            </div>
        </div>

        <!-- Files and Folders List -->
        <div class="bg-white rounded shadow-sm overflow-hidden">
            <div id="loading" class="p-6 text-center text-gray-500">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-sm">Loading...</p>
            </div>
            <div id="content" class="hidden">
                <div id="folders-list"></div>
                <div id="files-list"></div>
                <div id="empty-state" class="p-6 text-center text-gray-500 hidden">
                    <i data-feather="folder" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>No files or folders here</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Upload Modal -->
    <div id="upload-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-40">
        <div class="bg-white rounded shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="p-6">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i data-feather="upload" class="w-5 h-5"></i>
                    Upload Files & Folders
                </h2>

                <!-- Upload Options -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- File Upload -->
                    <div
                        class="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-blue-400 transition-colors">
                        <div class="text-center">
                            <i data-feather="file" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                            <h3 class="font-medium text-gray-700 mb-2">Upload Files</h3>
                            <input type="file" id="file-input" multiple class="hidden">
                            <button onclick="document.getElementById('file-input').click()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition">
                                Select Files
                            </button>
                        </div>
                    </div>

                    <!-- Folder Upload -->
                    <div
                        class="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-green-400 transition-colors">
                        <div class="text-center">
                            <i data-feather="folder" class="w-8 h-8 text-green-400 mx-auto mb-2"></i>
                            <h3 class="font-medium text-gray-700 mb-2">Upload Folder</h3>
                            <input type="file" id="folder-input" webkitdirectory multiple class="hidden">
                            <button onclick="document.getElementById('folder-input').click()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm transition">
                                Select Folder
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Selected Items Display -->
                <div id="selected-items" class="hidden">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-medium text-gray-700 flex items-center gap-2">
                            <i data-feather="list" class="w-4 h-4"></i>
                            Selected Items
                        </h3>
                        <button onclick="clearAllSelections()" class="text-xs text-red-600 hover:text-red-800 underline"
                            title="Clear all selections">
                            Clear All
                        </button>
                    </div>
                    <div class="max-h-60 overflow-y-auto border rounded p-3 bg-gray-50">
                        <div id="selected-files-list" class="space-y-1"></div>
                    </div>
                </div>

                <!-- Upload Progress (hidden by default) -->
                <div id="upload-progress" class="hidden mt-4">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-feather="loader" class="w-4 h-4 animate-spin"></i>
                        <span class="text-sm text-gray-600">Uploading...</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button onclick="closeUploadModal()"
                        class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded hover:bg-gray-50 transition">Cancel</button>
                    <button onclick="uploadFiles()" id="upload-btn"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-feather="upload" class="w-4 h-4 inline mr-1"></i>
                        Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Folder Modal -->
    <div id="create-folder-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-40">
        <div class="bg-white rounded shadow-xl max-w-md w-full mx-4">
            <div class="p-4">
                <h2 class="text-lg font-bold mb-3">Create New Folder</h2>
                <input type="text" id="folder-name-input" placeholder="Folder name"
                    class="w-full border border-gray-300 rounded p-2 mb-3 text-sm">
                <div class="flex justify-end gap-2">
                    <button onclick="closeCreateFolderModal()"
                        class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800">Cancel</button>
                    <button onclick="createFolder()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1.5 rounded text-sm">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create File Modal -->
    <div id="create-file-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-40">
        <div class="bg-white rounded shadow-xl max-w-md w-full mx-4">
            <div class="p-4">
                <h2 class="text-lg font-bold mb-3">Create New File</h2>
                <input type="text" id="file-name-input" placeholder="File name (e.g., data.json)"
                    class="w-full border border-gray-300 rounded p-2 mb-3 text-sm">
                <textarea id="file-content-input" placeholder="File content (JSON)"
                    class="w-full border border-gray-300 rounded p-2 mb-3 h-24 text-sm"></textarea>
                <div class="flex justify-end gap-2">
                    <button onclick="closeCreateFileModal()"
                        class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800">Cancel</button>
                    <button onclick="createFile()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1.5 rounded text-sm">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Folder Modal -->
    <div id="rename-folder-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-40">
        <div class="bg-white rounded shadow-xl max-w-md w-full mx-4">
            <div class="p-4">
                <h2 class="text-lg font-bold mb-3">Rename Folder</h2>
                <input type="text" id="rename-folder-input" placeholder="New folder name"
                    class="w-full border border-gray-300 rounded p-2 mb-3 text-sm">
                <div class="flex justify-end gap-2">
                    <button onclick="closeRenameFolderModal()"
                        class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800">Cancel</button>
                    <button onclick="renameFolder()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1.5 rounded text-sm">Rename</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFolder = '';
        let renamingFolder = '';
        let selectedFiles = new Set();
        let lastSelectedIndex = -1;
        let allFilesList = []; // Store ordered list of all files

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentFolder();
        });

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast px-6 py-3 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Navigation
        function navigateToRoot() {
            currentFolder = '';
            loadCurrentFolder();
        }

        function navigateToFolder(folder) {
            currentFolder = folder.replace(/\/$/, '');
            loadCurrentFolder();
        }

        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            if (!currentFolder) {
                breadcrumb.innerHTML = '';
                return;
            }
            const parts = currentFolder.split('/');
            breadcrumb.innerHTML = parts.map((part, index) => {
                const path = parts.slice(0, index + 1).join('/');
                return `<span class="text-gray-400">/</span> <button onclick="navigateToFolder('${path}')" class="text-blue-600 hover:text-blue-800">${part}</button>`;
            }).join(' ');
        }

        // Load files and folders
        async function loadCurrentFolder() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            updateBreadcrumb();

            try {
                const response = await fetch(`/list-files?folder=${currentFolder}`);
                const data = await response.json();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

                displayFolders(data.folders || []);
                displayFiles(data.files || []);

                // Count actual files (excluding folders and placeholders)
                const actualFiles = (data.files || []).filter(file => !file.endsWith('/') && !file.endsWith('/.placeholder'));
                const hasContent = (data.folders?.length > 0) || (actualFiles.length > 0);

                // Show empty state when there's NO content
                if (hasContent) {
                    document.getElementById('empty-state').classList.add('hidden');
                } else {
                    document.getElementById('empty-state').classList.remove('hidden');
                }
            } catch (error) {
                showToast('Failed to load files: ' + error.message, 'error');
            }
        }

        // Natural sort function for proper numeric sorting
        function naturalSort(a, b) {
            const nameA = a.split('/').pop().toLowerCase();
            const nameB = b.split('/').pop().toLowerCase();

            // Split strings into chunks of numbers and non-numbers
            const chunkify = (str) => {
                const chunks = [];
                let current = '';
                let isNumber = false;

                for (let i = 0; i < str.length; i++) {
                    const char = str[i];
                    const charIsNumber = /\d/.test(char);

                    if (charIsNumber !== isNumber) {
                        if (current) {
                            chunks.push({ value: current, isNumber });
                        }
                        current = char;
                        isNumber = charIsNumber;
                    } else {
                        current += char;
                    }
                }

                if (current) {
                    chunks.push({ value: current, isNumber });
                }

                return chunks;
            };

            const chunksA = chunkify(nameA);
            const chunksB = chunkify(nameB);

            const maxLen = Math.max(chunksA.length, chunksB.length);

            for (let i = 0; i < maxLen; i++) {
                const chunkA = chunksA[i] || { value: '', isNumber: false };
                const chunkB = chunksB[i] || { value: '', isNumber: false };

                if (chunkA.isNumber && chunkB.isNumber) {
                    // Both are numbers, compare numerically
                    const numA = parseInt(chunkA.value);
                    const numB = parseInt(chunkB.value);
                    if (numA !== numB) {
                        return numA - numB;
                    }
                } else {
                    // At least one is not a number, compare as strings
                    const cmp = chunkA.value.localeCompare(chunkB.value);
                    if (cmp !== 0) {
                        return cmp;
                    }
                }
            }

            return 0;
        }

        function displayFolders(folders) {
            const foldersList = document.getElementById('folders-list');
            foldersList.innerHTML = '';

            // Sort folders alphabetically by name using natural sort
            folders.sort(naturalSort);

            folders.forEach(folder => {
                const folderName = folder.replace(/\/$/, '').split('/').pop();
                const div = document.createElement('div');
                div.className = 'folder-item border-b border-gray-200 p-2 flex items-center justify-between cursor-pointer';
                div.innerHTML = `
                    <div class="flex items-center gap-2 flex-1" onclick="navigateToFolder('${folder.replace(/\/$/, '')}')">
                        <i data-feather="folder" class="w-5 h-5 text-gray-600"></i>
                        <span class="font-medium text-gray-900 text-sm">${folderName}</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="event.stopPropagation(); openRenameFolderModal('${folder.replace(/\/$/, '')}')" class="action-btn text-gray-600 hover:text-gray-800 hover:bg-gray-50 rounded transition" title="Rename">
                            <i data-feather="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="event.stopPropagation(); duplicateFolder('${folder.replace(/\/$/, '')}')" class="action-btn text-gray-600 hover:text-gray-800 hover:bg-gray-50 rounded transition" title="Duplicate">
                            <i data-feather="copy" class="w-4 h-4"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteFolder('${folder.replace(/\/$/, '')}')" class="action-btn text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition" title="Delete">
                            <i data-feather="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                foldersList.appendChild(div);
            });
        }

        function displayFiles(files) {
            const filesList = document.getElementById('files-list');
            filesList.innerHTML = '';

            // Filter and store all files for shift-select
            allFilesList = files.filter(file => !file.endsWith('/') && !file.endsWith('/.placeholder') && file.split('/').pop());

            // Sort files alphabetically by name using natural sort
            allFilesList.sort(naturalSort);

            allFilesList.forEach((file, index) => {
                const fileName = file.split('/').pop();
                const fileExt = fileName.split('.').pop().toLowerCase();
                const icon = getFileIcon(fileExt);
                const isSelected = selectedFiles.has(file);

                const div = document.createElement('div');
                div.className = `file-item border-b border-gray-200 p-2 flex items-center justify-between cursor-pointer transition-colors ${isSelected ? 'selected' : ''}`;
                div.dataset.file = file;
                div.dataset.index = index;

                // Add click handler with shift-select support
                div.onclick = (e) => {
                    if (!e.target.closest('button')) {
                        handleFileClick(file, index, e);
                    }
                };

                // Add mouseover handler for shift-select preview
                div.onmouseover = (e) => {
                    if (e.shiftKey && lastSelectedIndex !== -1) {
                        highlightRange(index);
                    }
                };

                div.onmouseout = () => {
                    clearRangeHighlight();
                };

                div.innerHTML = `
                    <div class="flex items-center gap-2 flex-1">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} 
                               onclick="event.stopPropagation(); handleFileClick('${file}', ${index}, event)" 
                               class="w-4 h-4 text-gray-600 rounded focus:ring-2 focus:ring-gray-500 cursor-pointer">
                        <i data-feather="${getFileIcon(fileExt)}" class="w-5 h-5 text-gray-600"></i>
                        <span class="text-gray-700 text-sm truncate">${fileName}</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="event.stopPropagation(); getFileUrl('${file}')" 
                                class="action-btn text-gray-600 hover:text-gray-800 hover:bg-gray-50 rounded transition" 
                                title="Get URL">
                            <i data-feather="link" class="w-4 h-4"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteFile('${file}')" 
                                class="action-btn text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition" 
                                title="Delete">
                            <i data-feather="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                filesList.appendChild(div);
            });
        }

        function handleFileClick(file, index, event) {
            if (event.shiftKey && lastSelectedIndex !== -1) {
                // Shift-click: select range
                const start = Math.min(lastSelectedIndex, index);
                const end = Math.max(lastSelectedIndex, index);

                // Select all files in range
                for (let i = start; i <= end; i++) {
                    selectedFiles.add(allFilesList[i]);
                }
            } else if (event.ctrlKey || event.metaKey) {
                // Ctrl/Cmd-click: toggle single file
                toggleFileSelection(file);
            } else {
                // Regular click: toggle single file
                toggleFileSelection(file);
            }

            lastSelectedIndex = index;
            updateSelectionUI();
        }

        function toggleFileSelection(file) {
            if (selectedFiles.has(file)) {
                selectedFiles.delete(file);
            } else {
                selectedFiles.add(file);
            }
        }

        function updateSelectionUI() {
            const count = selectedFiles.size;
            const hasFiles = allFilesList.length > 0;
            const allSelected = count === allFilesList.length && count > 0;

            document.getElementById('selected-count').textContent = count;
            document.getElementById('delete-selected-btn').classList.toggle('hidden', count === 0);
            document.getElementById('clear-selection-btn').classList.toggle('hidden', count === 0);

            // Update select all button
            const selectAllBtn = document.getElementById('select-all-btn');
            if (allSelected) {
                selectAllBtn.innerHTML = '<i data-feather="check-square" class="w-4 h-4 inline mr-1"></i>All Selected';
                selectAllBtn.classList.add('bg-gray-800', 'hover:bg-gray-900');
                selectAllBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            } else {
                selectAllBtn.innerHTML = '<i data-feather="check-square" class="w-4 h-4 inline mr-1"></i>Select All';
                selectAllBtn.classList.remove('bg-gray-800', 'hover:bg-gray-900');
                selectAllBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
            }
            refreshIcons();
            selectAllBtn.classList.toggle('hidden', !hasFiles);

            // Update checkboxes and row styles
            document.querySelectorAll('.file-item').forEach(item => {
                const file = item.dataset.file;
                const isSelected = selectedFiles.has(file);
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = isSelected;
                item.classList.toggle('selected', isSelected);
            });
        }

        function clearSelection() {
            selectedFiles.clear();
            lastSelectedIndex = -1;
            updateSelectionUI();
        }

        function selectAllFiles() {
            allFilesList.forEach(file => selectedFiles.add(file));
            updateSelectionUI();
        }

        function highlightRange(endIndex) {
            if (lastSelectedIndex === -1) return;

            const start = Math.min(lastSelectedIndex, endIndex);
            const end = Math.max(lastSelectedIndex, endIndex);

            document.querySelectorAll('.file-item').forEach((item, idx) => {
                if (idx >= start && idx <= end) {
                    item.classList.add('range-hover');
                }
            });
        }

        function clearRangeHighlight() {
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('range-hover');
            });
        }

        // Select all files (Ctrl+A)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'a' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                selectAllFiles();
            }
            // Escape to clear selection
            if (e.key === 'Escape') {
                clearSelection();
            }
        });

        async function deleteSelectedFiles() {
            if (selectedFiles.size === 0) return;

            if (!confirm(`Delete ${selectedFiles.size} selected file(s)?`)) return;

            // Group files by folder for batch deletion
            const filesByFolder = new Map();

            Array.from(selectedFiles).forEach(file => {
                const fileName = file.split('/').pop();
                const folder = file.substring(0, file.lastIndexOf('/')) || '';

                if (!filesByFolder.has(folder)) {
                    filesByFolder.set(folder, []);
                }
                filesByFolder.get(folder).push({ file, fileName });
            });

            // Send batch delete requests per folder
            const deletePromises = Array.from(filesByFolder).map(async ([folder, fileList]) => {
                const fileNames = fileList.map(item => item.fileName);

                try {
                    const response = await fetch('/delete-file', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folder, fileNames })
                    });

                    const result = await response.json();

                    if (!response.ok && response.status !== 207) {
                        throw new Error(result.error || 'Batch delete failed');
                    }

                    // Handle partial success (207) or full success (200)
                    const deletedCount = result.deleted !== undefined ? result.deleted : fileNames.length;
                    const failedCount = result.failed || 0;

                    return {
                        success: deletedCount > 0,
                        partial: response.status === 207,
                        deleted: deletedCount,
                        failed: failedCount,
                        files: fileList.map(item => item.file),
                        errors: result.errors
                    };
                } catch (error) {
                    return { success: false, files: fileList.map(item => item.file), error: error.message };
                }
            });

            const results = await Promise.all(deletePromises);

            // Flatten results for counting
            const allResults = results.flatMap(result => {
                if (result.partial) {
                    // Handle partial success - create separate results for deleted and failed files
                    const deletedFiles = result.files.slice(0, result.deleted);
                    const failedFiles = result.files.slice(result.deleted);

                    const results = [];
                    deletedFiles.forEach(file => results.push({ success: true, file }));
                    failedFiles.forEach(file => results.push({ success: false, file, error: 'File not found or delete failed' }));
                    return results;
                } else {
                    // Handle full success or full failure
                    return result.files.map(file => ({ success: result.success, file, error: result.error }));
                }
            });

            const successCount = allResults.filter(r => r.success).length;
            const failCount = allResults.filter(r => !r.success).length;

            if (successCount > 0) {
                showToast(`${successCount} file(s) deleted successfully${failCount > 0 ? `, ${failCount} failed` : ''}`);
            }
            if (failCount > 0 && successCount === 0) {
                showToast(`Failed to delete ${failCount} file(s)`, 'error');
            }

            selectedFiles.clear();
            loadCurrentFolder();
        }

        function getFileIcon(ext) {
            const icons = {
                'jpg': 'image', 'jpeg': 'image', 'png': 'image', 'gif': 'image', 'svg': 'image',
                'mp4': 'video', 'avi': 'video', 'mov': 'video', 'mkv': 'video',
                'mp3': 'music', 'wav': 'music', 'flac': 'music',
                'pdf': 'file-text', 'doc': 'file-text', 'docx': 'file-text', 'txt': 'file-text',
                'json': 'code', 'xml': 'code', 'csv': 'table',
                'zip': 'archive', 'rar': 'archive', '7z': 'archive'
            };
            return icons[ext] || 'file';
        }

        // Upload files
        let selectedFilesForUpload = [];
        let selectedFoldersForUpload = [];

        // Initialize upload modal
        document.addEventListener('DOMContentLoaded', () => {
            // File input handler
            document.getElementById('file-input').addEventListener('change', handleFileSelection);
            // Folder input handler
            document.getElementById('folder-input').addEventListener('change', handleFolderSelection);
        });

        function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            selectedFilesForUpload = files;
            selectedFoldersForUpload = [];
            displaySelectedItems();
        }

        function handleFolderSelection(event) {
            const files = Array.from(event.target.files);
            selectedFilesForUpload = [];
            selectedFoldersForUpload = organizeFolderStructure(files);
            displaySelectedItems();
        }

        function organizeFolderStructure(files) {
            const folderStructure = {};

            files.forEach(file => {
                const pathParts = file.webkitRelativePath.split('/');
                let current = folderStructure;

                pathParts.forEach((part, index) => {
                    if (!current[part]) {
                        current[part] = index === pathParts.length - 1 ? file : {};
                    }
                    current = current[part];
                });
            });

            return folderStructure;
        }

        function displaySelectedItems() {
            const container = document.getElementById('selected-items');
            const list = document.getElementById('selected-files-list');

            if (selectedFilesForUpload.length === 0 && Object.keys(selectedFoldersForUpload).length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            list.innerHTML = '';

            // Display selected files
            if (selectedFilesForUpload.length > 0) {
                const filesHeader = document.createElement('div');
                filesHeader.className = 'font-medium text-blue-600 mb-2 flex items-center gap-2';
                filesHeader.innerHTML = '<i data-feather="file" class="w-4 h-4"></i>Files';
                list.appendChild(filesHeader);

                selectedFilesForUpload.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center gap-2 text-sm text-gray-700 pl-4 group';
                    item.innerHTML = `
                        <i data-feather="file-text" class="w-3 h-3 text-gray-400"></i>
                        <span class="truncate flex-1">${file.name}</span>
                        <span class="text-xs text-gray-500">(${formatFileSize(file.size)})</span>
                        <button onclick="removeSelectedFile(${index})" 
                                class="opacity-30 group-hover:opacity-100 text-red-500 hover:text-red-700 p-1 rounded transition-opacity"
                                title="Remove file">
                            <i data-feather="x" class="w-3 h-3 text-black"></i>
                        </button>
                    `;
                    list.appendChild(item);
                });
            }

            // Display selected folders
            if (Object.keys(selectedFoldersForUpload).length > 0) {
                if (selectedFilesForUpload.length > 0) {
                    list.appendChild(document.createElement('hr'));
                }

                const foldersHeader = document.createElement('div');
                foldersHeader.className = 'font-medium text-green-600 mb-2 flex items-center gap-2';
                foldersHeader.innerHTML = '<i data-feather="folder" class="w-4 h-4"></i>Folders';
                list.appendChild(foldersHeader);

                displayFolderStructure(selectedFoldersForUpload, list, 0, '');
            }

            refreshIcons();
        }

        function displayFolderStructure(structure, container, depth = 0, path = '') {
            // Separate folders and files, and sort them alphabetically
            const folders = [];
            const files = [];

            Object.entries(structure).forEach(([name, content]) => {
                if (content instanceof File) {
                    files.push([name, content]);
                } else {
                    folders.push([name, content]);
                }
            });

            // Sort folders and files alphabetically
            folders.sort((a, b) => a[0].localeCompare(b[0]));
            files.sort((a, b) => a[0].localeCompare(b[0]));

            // Display folders first, then files
            [...folders, ...files].forEach(([name, content]) => {
                const item = document.createElement('div');

                if (content instanceof File) {
                    // It's a file
                    item.className = 'flex items-center gap-2 text-sm text-gray-700 group';
                    item.style.paddingLeft = `${(depth + 1) * 16}px`;
                    item.innerHTML = `
                        <i data-feather="file-text" class="w-3 h-3 text-gray-400"></i>
                        <span class="truncate flex-1">${name}</span>
                        <span class="text-xs text-gray-500">(${formatFileSize(content.size)})</span>
                        <button onclick="removeSelectedFileFromFolder('${path ? path + '/' + name : name}')" 
                                class="opacity-30 group-hover:opacity-100 text-red-500 hover:text-red-700 p-1 rounded transition-opacity"
                                title="Remove file">
                            <i data-feather="x" class="w-3 h-3"></i>
                        </button>
                    `;
                } else {
                    // It's a folder
                    item.className = 'flex items-center gap-2 text-sm text-gray-700 font-medium group';
                    item.style.paddingLeft = `${depth * 16}px`;
                    item.innerHTML = `
                        <i data-feather="folder" class="w-3 h-3 text-green-500"></i>
                        <span class="flex-1">${name}/</span>
                        <button onclick="removeSelectedFolder('${path ? path + '/' + name : name}')" 
                                class="opacity-30 group-hover:opacity-100 text-red-500 hover:text-red-700 p-1 rounded transition-opacity"
                                title="Remove folder">
                            <i data-feather="x" class="w-3 h-3"></i>
                        </button>
                    `;
                    // Append folder first, then recursively display its contents
                    container.appendChild(item);
                    displayFolderStructure(content, container, depth + 1, path ? path + '/' + name : name);
                    return; // Skip the append at the end since we already appended
                }

                container.appendChild(item);
            });
        }

        function removeSelectedFileFromFolder(filePath) {
            function removeFromStructure(structure, pathParts) {
                if (pathParts.length === 1) {
                    delete structure[pathParts[0]];
                    return true;
                }

                const [current, ...rest] = pathParts;
                if (structure[current] && typeof structure[current] === 'object' && !structure[current].webkitRelativePath) {
                    const removed = removeFromStructure(structure[current], rest);
                    if (removed && Object.keys(structure[current]).length === 0) {
                        delete structure[current];
                    }
                    return removed;
                }
                return false;
            }

            const pathParts = filePath.split('/');
            removeFromStructure(selectedFoldersForUpload, pathParts);
            displaySelectedItems();
        }

        function removeSelectedFolder(folderPath) {
            function removeFromStructure(structure, pathParts) {
                if (pathParts.length === 1) {
                    delete structure[pathParts[0]];
                    return true;
                }

                const [current, ...rest] = pathParts;
                if (structure[current] && typeof structure[current] === 'object' && !structure[current].webkitRelativePath) {
                    const removed = removeFromStructure(structure[current], rest);
                    if (removed && Object.keys(structure[current]).length === 0) {
                        delete structure[current];
                    }
                    return removed;
                }
                return false;
            }

            const pathParts = folderPath.split('/');
            removeFromStructure(selectedFoldersForUpload, pathParts);
            displaySelectedItems();
        }

        function removeSelectedFile(index) {
            selectedFilesForUpload.splice(index, 1);
            displaySelectedItems();
        }

        function clearAllSelections() {
            selectedFilesForUpload = [];
            selectedFoldersForUpload = {};
            displaySelectedItems();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function openUploadModal() {
            document.getElementById('upload-modal').classList.add('active');
            // Reset selections
            selectedFilesForUpload = [];
            selectedFoldersForUpload = [];
            document.getElementById('file-input').value = '';
            document.getElementById('folder-input').value = '';
            document.getElementById('selected-items').classList.add('hidden');
            document.getElementById('upload-progress').classList.add('hidden');
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').classList.remove('active');
            document.getElementById('file-input').value = '';
            document.getElementById('folder-input').value = '';
            selectedFilesForUpload = [];
            selectedFoldersForUpload = [];
        }

        async function uploadFiles() {
            const allFiles = [...selectedFilesForUpload, ...flattenFolderStructure(selectedFoldersForUpload)];

            if (allFiles.length === 0) {
                showToast('Please select files or folders to upload', 'error');
                return;
            }

            const uploadBtn = document.getElementById('upload-btn');
            const progressContainer = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const selectedItemsContainer = document.getElementById('selected-items');

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i data-feather="loader" class="w-4 h-4 inline mr-1 animate-spin"></i>Uploading...';
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';

            // Disable selected items during upload
            if (selectedItemsContainer) {
                selectedItemsContainer.style.pointerEvents = 'none';
                selectedItemsContainer.style.opacity = '0.5';
            }

            let uploadedCount = 0;
            const totalFiles = allFiles.length;

            try {
                // For folder uploads, first create all necessary folders
                if (Object.keys(selectedFoldersForUpload).length > 0) {
                    const folderPaths = getAllFolderPaths(selectedFoldersForUpload);
                    for (const folderPath of folderPaths) {
                        const fullPath = currentFolder ? `${currentFolder}/${folderPath}` : folderPath;
                        await createFolderIfNotExists(fullPath);
                    }
                }

                // Group files by their target folder for batch uploading
                const filesByFolder = new Map();

                for (const file of allFiles) {
                    const relativePath = file.webkitRelativePath || file.name;
                    const pathParts = relativePath.split('/');
                    const fileName = pathParts.pop();
                    const fileFolder = pathParts.join('/');

                    // For single files, use current folder directly; for folder uploads, append the relative path
                    const targetFolder = fileFolder ?
                        (currentFolder ? `${currentFolder}/${fileFolder}` : fileFolder) :
                        (currentFolder || 'uploads');

                    if (!filesByFolder.has(targetFolder)) {
                        filesByFolder.set(targetFolder, []);
                    }
                    filesByFolder.get(targetFolder).push({ file, fileName });
                }

                // Upload files in batches grouped by folder
                const batchSize = 10; // Upload up to 10 files per request

                for (const [targetFolder, fileList] of filesByFolder) {
                    for (let i = 0; i < fileList.length; i += batchSize) {
                        const batch = fileList.slice(i, i + batchSize);
                        await uploadBatch(batch, targetFolder);

                        uploadedCount += batch.length;
                        const progress = (uploadedCount / totalFiles) * 100;
                        progressBar.style.width = `${progress}%`;
                    }
                }

                showToast(`${totalFiles} file(s) uploaded successfully`);
                closeUploadModal();
                loadCurrentFolder();
            } catch (error) {
                showToast('Upload failed: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i data-feather="upload" class="w-4 h-4 inline mr-1"></i>Upload';
                progressContainer.classList.add('hidden');

                // Re-enable selected items after upload
                if (selectedItemsContainer) {
                    selectedItemsContainer.style.pointerEvents = '';
                    selectedItemsContainer.style.opacity = '';
                }

                refreshIcons();
            }
        }

        function getAllFolderPaths(structure, prefix = '') {
            const paths = [];

            Object.entries(structure).forEach(([name, content]) => {
                const currentPath = prefix ? `${prefix}/${name}` : name;

                if (!(content instanceof File)) {
                    paths.push(currentPath);
                    paths.push(...getAllFolderPaths(content, currentPath));
                }
            });

            return paths;
        }

        async function createFolderIfNotExists(folderPath) {
            try {
                const response = await fetch('/create-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder: folderPath,
                        fileName: '.placeholder',
                        content: {}
                    })
                });
                // Ignore if folder already exists
            } catch (error) {
                // Ignore errors for folder creation
            }
        }

        async function uploadSingleFile(file, folder, fileName) {
            const formData = new FormData();
            formData.append('folder', folder);
            formData.append('files', file, fileName);

            const response = await fetch('/upload-files', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.error || 'Upload failed');
            }
        }

        async function uploadBatch(fileObjects, targetFolder) {
            const formData = new FormData();
            formData.append('folder', targetFolder);

            fileObjects.forEach(({ file, fileName }) => {
                formData.append('files', file, fileName);
            });

            const response = await fetch('/upload-files', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.error || 'Upload failed');
            }
        }

        function flattenFolderStructure(structure, path = '') {
            const files = [];

            Object.entries(structure).forEach(([name, content]) => {
                const currentPath = path ? `${path}/${name}` : name;

                if (content instanceof File) {
                    // Create a new file object with the correct path
                    const fileWithPath = new File([content], currentPath, { type: content.type });
                    Object.defineProperty(fileWithPath, 'webkitRelativePath', {
                        value: currentPath,
                        writable: false
                    });
                    files.push(fileWithPath);
                } else {
                    // Recursively flatten subfolders
                    files.push(...flattenFolderStructure(content, currentPath));
                }
            });

            return files;
        }

        // Create folder
        function openCreateFolderModal() {
            document.getElementById('create-folder-modal').classList.add('active');
        }

        function closeCreateFolderModal() {
            document.getElementById('create-folder-modal').classList.remove('active');
            document.getElementById('folder-name-input').value = '';
        }

        async function createFolder() {
            const folderName = document.getElementById('folder-name-input').value.trim();

            if (!folderName) {
                showToast('Please enter a folder name', 'error');
                return;
            }

            const fullPath = currentFolder ? `${currentFolder}/${folderName}` : folderName;

            try {
                const response = await fetch('/create-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder: fullPath,
                        fileName: '.placeholder',
                        content: {}
                    })
                });

                if (response.ok) {
                    showToast('Folder created successfully');
                    closeCreateFolderModal();
                    loadCurrentFolder();
                } else {
                    const result = await response.json();
                    showToast(result.error || 'Failed to create folder', 'error');
                }
            } catch (error) {
                showToast('Failed to create folder: ' + error.message, 'error');
            }
        }

        // Create file
        function openCreateFileModal() {
            document.getElementById('create-file-modal').classList.add('active');
        }

        function closeCreateFileModal() {
            document.getElementById('create-file-modal').classList.remove('active');
            document.getElementById('file-name-input').value = '';
            document.getElementById('file-content-input').value = '';
        }

        async function createFile() {
            const fileName = document.getElementById('file-name-input').value.trim();
            const fileContent = document.getElementById('file-content-input').value.trim();

            if (!fileName) {
                showToast('Please enter a file name', 'error');
                return;
            }

            let content = {};
            if (fileContent) {
                try {
                    content = JSON.parse(fileContent);
                } catch (e) {
                    showToast('Invalid JSON content', 'error');
                    return;
                }
            }

            try {
                const response = await fetch('/create-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder: currentFolder || 'root',
                        fileName: fileName,
                        content: content
                    })
                });

                if (response.ok) {
                    showToast('File created successfully');
                    closeCreateFileModal();
                    loadCurrentFolder();
                } else {
                    const result = await response.json();
                    showToast(result.error || 'Failed to create file', 'error');
                }
            } catch (error) {
                showToast('Failed to create file: ' + error.message, 'error');
            }
        }

        // Rename folder
        function openRenameFolderModal(folder) {
            renamingFolder = folder;
            const folderName = folder.split('/').pop();
            document.getElementById('rename-folder-input').value = folderName;
            document.getElementById('rename-folder-modal').classList.add('active');
        }

        function closeRenameFolderModal() {
            document.getElementById('rename-folder-modal').classList.remove('active');
            renamingFolder = '';
        }

        async function renameFolder() {
            const newName = document.getElementById('rename-folder-input').value.trim();

            if (!newName) {
                showToast('Please enter a new folder name', 'error');
                return;
            }

            const parentPath = renamingFolder.split('/').slice(0, -1).join('/');
            const targetFolder = parentPath ? `${parentPath}/${newName}` : newName;

            try {
                const response = await fetch('/rename-folder', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sourceFolder: renamingFolder,
                        targetFolder: targetFolder
                    })
                });

                if (response.ok) {
                    showToast('Folder renamed successfully');
                    closeRenameFolderModal();
                    loadCurrentFolder();
                } else {
                    const result = await response.json();
                    showToast(result.error || 'Failed to rename folder', 'error');
                }
            } catch (error) {
                showToast('Failed to rename folder: ' + error.message, 'error');
            }
        }

        // Duplicate folder
        async function duplicateFolder(folder) {
            const folderName = folder.split('/').pop();
            const targetFolder = `${folder}_copy`;

            if (!confirm(`Duplicate folder "${folderName}"?`)) return;

            try {
                const response = await fetch('/duplicate-folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sourceFolder: folder,
                        targetFolder: targetFolder
                    })
                });

                if (response.ok) {
                    showToast('Folder duplicated successfully');
                    loadCurrentFolder();
                } else {
                    const result = await response.json();
                    showToast(result.error || 'Failed to duplicate folder', 'error');
                }
            } catch (error) {
                showToast('Failed to duplicate folder: ' + error.message, 'error');
            }
        }

        // Delete folder
        async function deleteFolder(folder) {
            const folderName = folder.split('/').pop();

            if (!confirm(`Delete folder "${folderName}" and all its contents?`)) return;

            try {
                const response = await fetch('/delete-file', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder: folder,
                        fileName: '*'
                    })
                });

                if (response.ok) {
                    showToast('Folder deleted successfully');
                    loadCurrentFolder();
                } else {
                    const result = await response.json();
                    showToast(result.error || 'Failed to delete folder', 'error');
                }
            } catch (error) {
                showToast('Failed to delete folder: ' + error.message, 'error');
            }
        }

        // Delete file
        async function deleteFile(file) {
            const fileName = file.split('/').pop();
            const folder = file.substring(0, file.lastIndexOf('/'));

            if (!confirm(`Delete file "${fileName}"?`)) return;

            try {
                const response = await fetch('/delete-file', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder: folder,
                        fileName: fileName
                    })
                });

                if (response.ok) {
                    showToast('File deleted successfully');
                    loadCurrentFolder();
                } else {
                    const result = await response.json();
                    showToast(result.error || 'Failed to delete file', 'error');
                }
            } catch (error) {
                showToast('Failed to delete file: ' + error.message, 'error');
            }
        }

        // Get file URL
        async function getFileUrl(file) {
            const folder = file.substring(0, file.lastIndexOf('/'));

            try {
                const response = await fetch(`/get-file-urls?folder=${folder}&expires=3600`);
                const urls = await response.json();

                const fileUrl = urls.find(u => u.fileKey === file);

                if (fileUrl) {
                    navigator.clipboard.writeText(fileUrl.url);
                    showToast('URL copied to clipboard!');
                } else {
                    showToast('Failed to get file URL', 'error');
                }
            } catch (error) {
                showToast('Failed to get file URL: ' + error.message, 'error');
            }
        }

        // Initialize Feather icons
        document.addEventListener('DOMContentLoaded', function () {
            feather.replace();
        });

        // Re-initialize icons after dynamic content changes
        function refreshIcons() {
            feather.replace();
        }

        // Call refreshIcons after content updates
        const originalLoadCurrentFolder = loadCurrentFolder;
        loadCurrentFolder = async function () {
            await originalLoadCurrentFolder();
            setTimeout(refreshIcons, 10);
        };
    </script>
</body>

</html>